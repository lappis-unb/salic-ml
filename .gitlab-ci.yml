image: docker:stable

stages:
  - build-requirements
  - build-api

services:
  - docker:dind

build requirements:
  stage: build-requirements
  variables:
    SALICML_PROD_RELEASE_IMAGE: $CI_REGISTRY_IMAGE/salicml/requirements:latest
  script:
    - docker login -u "gitlab-ci-token" -p "$CI_JOB_TOKEN" $CI_REGISTRY
    - docker build -f docker/Dockerfile.base -t $SALICML_PROD_RELEASE_IMAGE .
    - docker push $SALICML_PROD_RELEASE_IMAGE
  only:
    - master

build api:
  stage: build-api
  variables:
    SALICML_PROD_RELEASE_IMAGE: $CI_REGISTRY_IMAGE/salicml/api:latest
  script:
    - docker login -u "gitlab-ci-token" -p "$CI_JOB_TOKEN" $CI_REGISTRY
    - docker build -f docker/Dockerfile.base -t $SALICML_PROD_RELEASE_IMAGE .
    - docker push $SALICML_PROD_RELEASE_IMAGE
  only:
    - master